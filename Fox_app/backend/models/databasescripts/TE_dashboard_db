-- Database: postgres

-- DROP DATABASE IF EXISTS postgres;

CREATE DATABASE postgres
    WITH
    OWNER = postgres

CREATE EXTENSION IF NOT EXISTS "pgcrypto";

CREATE TABLE fixtures (
id UUID PRIMARY KEY DEFAULT gen_random_uuid() ,
tester_type VARCHAR(32),
CHECK (tester_type = 'B Tester' OR tester_type = 'LA Slot' OR tester_type = 'RA Slot'),
fixture_name VARCHAR(32) UNIQUE,
rack VARCHAR(32),
fixture_sn VARCHAR(32),
test_type VARCHAR(32),
CHECK (test_type = 'Refurbish' OR test_type = 'Sort' OR test_type = 'NA'),
ip_address VARCHAR(16),
mac_address VARCHAR(17),
parent UUID,
CHECK (parent = null OR parent <> id),
FOREIGN KEY (parent) REFERENCES fixtures(id),
creator VARCHAR(32),
create_date TIMESTAMPTZ
);

CREATE TABLE health(
id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
fixture_name VARCHAR(32),
FOREIGN KEY (fixture_name) REFERENCES fixtures(fixture_name),
fixture_id UUID
FOREIGN KEY (fixture_id) REFERENCES fixtures(parent)),
status VARCHAR(32),
CHECK (status = 'active' OR status = 'no_response' OR status = 'under_maintenance' OR status = 'RMA'),
comments VARCHAR(256),
creator VARCHAR(32),
create_date TIMESTAMPTZ
);

CREATE TABLE usage(
id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
fixture_name VARCHAR(32),
FOREIGN KEY (fixture_name) REFERENCES fixtures(fixture_name),
fixture_id UUID,
FOREIGN KEY (fixture_id) REFERENCES fixtures(parent),
test_slot VARCHAR(32),
CHECK (test_slot = 'Left' OR test_slot = 'Right'),
test_station VARCHAR(32),
test_type VARCHAR(32),
CHECK (test_type = 'Refurbish' OR test_type = 'Sort' OR test_type = 'NA'),
gpu_pn VARCHAR(32),
gpu_sn VARCHAR(32),
log_path VARCHAR(256),
creator VARCHAR(32),
create_date TIMESTAMPTZ
);
